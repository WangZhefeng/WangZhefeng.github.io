---
title: 时间序列预测
author: 王哲峰
date: '2022-04-25'
slug: timeseries-forecast
categories:
  - timeseries
tags:
  - ml
---

<style>
details {
    border: 1px solid #aaa;
    border-radius: 4px;
    padding: .5em .5em 0;
}
summary {
    font-weight: bold;
    margin: -.5em -.5em 0;
    padding: .5em;
}
details[open] {
    padding: .5em;
}
details[open] summary {
    border-bottom: 1px solid #aaa;
    margin-bottom: .5em;
}
</style>

<details><summary>目录</summary><p>

- [时间序列预测综述](#时间序列预测综述)
- [基本规则法](#基本规则法)
- [传统参数法](#传统参数法)
- [时间序列分解](#时间序列分解)
  - [时间序列分解模型](#时间序列分解模型)
  - [时间序列的长期趋势分析](#时间序列的长期趋势分析)
    - [移动平均法](#移动平均法)
    - [时间回归法](#时间回归法)
  - [时间序列季节变动分析](#时间序列季节变动分析)
  - [时间序列循环变动分析](#时间序列循环变动分析)
  - [时间序列不规则变动分析](#时间序列不规则变动分析)
- [机器学习模型](#机器学习模型)
  - [单步预测](#单步预测)
  - [多步预测](#多步预测)
  - [多变量预测](#多变量预测)
    - [树模型](#树模型)
    - [神经网络模型](#神经网络模型)
- [难点](#难点)
- [参考](#参考)
</p></details><p></p>

# 时间序列预测综述

时间序列预测就是利用过去一段时间的数据来预测未来一段时间内的信息，
包括连续型预测（数值预测，范围估计）与离散型预测（事件预测）等，具有非常高的商业价值

需要明确一点的是，与回归分析预测模型不同，时间序列模型依赖于数值在时间上的先后顺序，
同样大小的值改变顺序后输入模型产生的结果是不同的。如之前的文章所介绍，
时间序列可以分为平稳序列，即存在某种周期，季节性及趋势的方差和均值不随时间而变化的序列，
和非平稳序列。如何对各种场景的时序数据做准确地预测，是一个非常值得研究的问题

# 基本规则法

要预测一个时间序列，我们首先需要发现其变化的规律。
最基本的方法，就是通过人工经验，挖掘时序数据的演化特征，找到时序变化的周期，
从而预估时间序列的未来走势。具体的观察一个时间序列，
当序列存在周期性时，提取时间序列的周期性特征进行预测

# 传统参数法

传统的参数预测方法可以分为两种：

* 一种拟合标准时间序列的参数方法，包括移动平均，指数平均等
* 另一种是考虑多因素组合的参数方法，即 AR, MA, ARMA 等模型

这类方法比较适用于小规模，单变量的预测，比如某门店的销量预测等。总的来说，基于此类方法的建模步骤是：

1. 首先，需要对观测值序列进行平稳性检测，如果不平稳，则对其进行差分运算直到差分后的数据平稳
2. 在数据平稳后则对其进行白噪声检验，白噪声是指零均值常方差的随机平稳序列
3. 如果是平稳非白噪声序列就计算 ACF(自相关系数)、PACF(偏自相关系数)，进行ARMA等模型识别，
   对已识别好的模型，确定模型参数，最后应用预测并进行误差分析

这类方法一般是统计或者金融出身的人用的比较多，对统计学或者随机过程知识的要求比较高。
而在数据挖掘的场景中比较难适用，因为需要大量的参数化建模。
比如有一个连锁门店的销售数据，要预测每个门店的未来销量，
用这类方法的话就需要对每个门店都建立模型，这样就很难操作了


# 时间序列分解

时间序列分解法是数年来一直非常有用的方法，一个时间序列往往是一下几类变化形式的叠加或耦合：

* 长期趋势(Secular trend, T)：长期趋势指现象在较长时期内持续发展变化的一种趋向或状态。
* 季节变动(Seasonal Variation, S)：季节波动是由于季节的变化引起的现象发展水平的规则变动
* 循环波动(Cyclical Variation, C)：循环波动指以若干年为期限，不具严格规则的周期性连续变动
* 不规则波动(Irregular Variation, I): 不规则波动指由于众多偶然因素对时间序列造成的影响

## 时间序列分解模型

* 加法模型
* 乘法模型
* 加乘混合模型

## 时间序列的长期趋势分析

### 移动平均法

### 时间回归法


## 时间序列季节变动分析


## 时间序列循环变动分析


## 时间序列不规则变动分析







# 机器学习模型

近年来时间序列预测方法，多采用机器学习方式。机器学习的方法，主要是构建样本数据集，
采用“时间特征”到“样本值”的方式，通过有监督学习，学习特征与标签之前的关联关系，
从而实现时间序列预测。常用的场景有

## 单步预测

在时间序列预测中的标准做法是使用滞后的观测值图片，作为输入变量来预测当前的时间的观测值图片。这被称为单步单变量预测

## 多步预测

另一种预测问题类型是使用过去的观测序列 图片来预测未来的观测序列图片。这就是多步预测或序列预测


## 多变量预测

另一个重要的时间序列称为多元时间序列，即每个时间有多个观测值：
图片
这意味着我们通过不同的测量手段得到了多种观测值，并且希望预测其中的一个或几个值。例如，我们可能有两组时间序列观测值图片，图片，我们希望分析这组多元时间序列来预测 图片。

基于以上场景，许多监督学习的方法可以应用在时间序列的预测中，比如svm/xgboost/逻辑回归/回归树/...


在运用机器学习模型时, 我们可以把时间序列模型当成一个回归问题来解决, 
常见的方法有树模型与神经网络模型两大类 

### 树模型

一般采用的是 xgboost 或者 lightgbm 的方法, 现在业界也被广泛应用, 这里就不多做介绍了. 
树模型的一个好处就是, 相对于以上的方法, 能更方便地添加一些 category 类的特征比如: 
是否季节末、是否公共价格、是否营业时间等. 

在用树模型做时间序列预测时, 特征工程的核心要点在于如何从历史的数据中抽取特征, 
这里介绍一些特征构建的经验: 

- 离散类时间特征: 年月日时分数, 周几, 一年中的第几天, 第几周, 一天中的哪个时间段等
- 判断类时间特征: 是否调休, 是否周末, 是否公共假期等
- 滑窗类时间聚合特征: 过去X天平均值, 过去X天方差, 过去X天最大值, 过去X小时四分位数, 过去X天偏态系数等
- 其他时序模型的预测值作为特征: ARIMA、SARIMA、指数平滑等
- 其他相关业务线数据的引入: 比如对于售后业务线, 引入售前业务线/预定业务线等数据, 帮忙进行售后业务线的预测

### 神经网络模型

常见的利用神经网络技术来做时间序列预测的方法有有 CNN、RNN、LSTM、GRU等.

相对于传统的树模型需要人工构建相关模型特征, 神经网络模型通常需要喂入大量的数据来进行训练, 
因此如果同类时序的数据量够多(有够多彼此间相关性较强的时序), 
那么训练一个通用型的端对端的神经网络预测有时也有不错的效果, 比如使用 LSTM 一方面可以较容易地整合外部变量, 
另一方面 LSTM 有能较好地自动提取时序特征的能力. 

在某条业务产线上, 我们针对多城市的数据进行建模, 训练了一个灵活单一通用的端对端 LSTM 时间预测模型. 
具体在训练时, 输入数据一方面包括了时间序列相关的数据, 另一方面也包括了天气、节假日等外部变量, 
同时使用了 encoder-decoder 来帮助提取时序特征, 在 T+14 的主要大城市时序预测上有较大的提升, 达到日 95%+ 的准确率. 

同时, 在实践中, 我们发现对于一些产线, 采用多任务学习的方法, 可以有效地提高模型的泛化性以及准确率, 
比如预测未来某天某些时段的值时, 将不同时段的值作为不同的任务目标来进行学习, 
或者是加入相关性很强的其他时序数据来作为不同的任务目标. 


# 难点

* 理解时间序列预测问题是要用历史数据预测未来数据
* 时间序列问题的训练集、测试集划分
* 特征工程方法及过程
* 如何转化为监督学习数据集
* LSTM 计算过程理解，包括输入输出维度、参数数量等
* seq2seq 过程的理解，decoder 实现
* attention 注意力机制的原理及实现，包括 encoder-decoder attention, self attention, multi-head attention 等
* 时间卷积网络的含义，dilated-convolution 和 causal-convolution
* prophet 预测原理，各参数对模型拟合效果、泛化效果的影响
* 时间序列基本规则法中周期因子得计算过程
* 传统方法如周期因子、线性回归、ARMA 等的预测结果表现为，预测趋势大致正确，但对波动预测不理想，体现在波动的幅度差异、相位偏移
* 时间序列分解方法。理解加法模型和乘法模型，判断分解模型的选取及分解技巧

# 参考

- [[1]时间序列预测](https://mp.weixin.qq.com/s?__biz=Mzg3NDUwNTM3MA==&mid=2247484974&idx=1&sn=d841c644fd9289ad5ec8c52a443463a5&chksm=cecef3dbf9b97acd8a9ededc069851afc00db422cb9be4d155cb2c2a9614b2ee2050dc7ab4d7&scene=21#wechat_redirect)