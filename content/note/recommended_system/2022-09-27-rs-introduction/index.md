---
title: 推荐算法业务
author: 王哲峰
date: '2022-09-27'
slug: rs-introduction
categories:
  - recommended system
tags:
  - algorithm
---

<style>
details {
    border: 1px solid #aaa;
    border-radius: 4px;
    padding: .5em .5em 0;
}
summary {
    font-weight: bold;
    margin: -.5em -.5em 0;
    padding: .5em;
}
details[open] {
    padding: .5em;
}
details[open] summary {
    border-bottom: 1px solid #aaa;
    margin-bottom: .5em;
}
</style>

<details><summary>目录</summary><p>

- [搜索和推荐](#搜索和推荐)
- [推荐系统的价值](#推荐系统的价值)
- [推荐系统架构](#推荐系统架构)
  - [索引池](#索引池)
  - [特征服务](#特征服务)
  - [排序模块](#排序模块)
    - [召回粗排精排](#召回粗排精排)
      - [召回](#召回)
      - [粗排](#粗排)
      - [精排](#精排)
    - [打压保送重排](#打压保送重排)
  - [展示逻辑](#展示逻辑)
  - [日志系统](#日志系统)
  - [分析系统](#分析系统)
- [推荐系统的局限性](#推荐系统的局限性)
</p></details><p></p>

# 搜索和推荐

搜索是人找物，而推荐是物找人。推荐一般用来满足用户比较明确的需求，
而推荐则可以用来满足用户相对模糊的需求

搜索有一定的使用门槛，用户需要输入关键词，至少要会打字，并相对准确的描述自己的兴趣。
但推荐几乎没有使用门槛，用户只要会刷新就可以了，每次刷新都会出来新的东西。
完成一个简单的推荐系统的方法就是每次请求都能保证出新的东西，也就是随机不重复推荐。
但搜索不能这么简单，搜索出来的东西一定是和输入相关的东西，不然就不叫搜索了。
一个较理想的推荐系统可以做到千人千面，根据用户偏好个性化地进行推荐

熟悉的推荐系统:

* 短视频推荐
* 新闻推荐
* 视屏推荐
* 音乐推荐
* 商品推荐

熟悉的搜索系统:

* 浏览器搜索引擎
* 电商商品搜索栏
* 问题搜索栏
* 人事搜索栏

# 推荐系统的价值

推荐系统是连接生产者和消费者的中间媒介。它对于生产者、消费者、以及平台都有各自的价值

* 对消费者：帮助消费者便捷地获取信息
* 对生产者，帮助生产者获取流量曝光和用户增长
* 对平台，平台可以通过卖广告赚取收益

一般来说，用户使用时长越长，平台就可以插入更多的广告。
所以，推荐系统常常以用户使用时长为核心优化指标

对于生产者，推荐系统非常重要的一点特性就是要具备长尾效应，
即少部分头部的作者能获得主要的曝光，但大多数中小创作者也必须要能够获得一定的流量。
否则大部分的作者创作积极性被打压掉之后，平台就会慢慢死掉。
一般发展比较好的推荐系统的，他们的长尾都做的非常好

# 推荐系统架构

> 如何搭建一个推荐系统？

![](https://tva1.sinaimg.cn/large/e6c9d24egy1h4oo37b5hjj20k00ekmxf.jpg)

## 索引池

第一步，需要知道有哪些东西可以推荐

这就需要一个索引池，里面存储了可能被推荐的全量内容的 id 以及它们的一些特征

对于有些有时效性的内容，比如新闻，在其时间过期之后，要从索引池中拿掉。
同时，通过审核与控制索引池中的内容，可以确保不犯致命错误，不推荐涉黄涉非的内容给用户

## 特征服务

第二步，当用户通过登录 APP 或者刷新操作触发了一个获取推荐信息的请求的时候，
需要知道这个用户当前有什么喜好

这就需要一个特征服务，用来获取用户的年龄、性别、地域等属性特征，
以及根据用户之前的浏览点赞等记录计算的行为特征

由于用户的喜好可能变化较快且需求较高，需要搭建服务以保证高性能

## 排序模块

第三步，需要确定把索引池中哪个内容或者哪些内容推荐给用户

这就需要一个排序模块，其目的是将索引池中所有内容按照用户可能的喜好程度进行排序。
如果索引池非常大，排序模块通常会进一步分成召回和排序两个阶段，
有些推荐系统还会在它们中间加上一个粗排阶段

此外，排序模块中通常还会使用一些打压、保送、重排的策略来对模型预测结果进行一些人为干预


### 召回粗排精排

![](https://tva1.sinaimg.cn/large/e6c9d24egy1h4p0jmhhv0j20k10bvq37.jpg)

推荐系统架构中的排序模块，一般会分成召回、粗排、精排三个阶段。
这几个阶段，可以比喻成索引库全部 item 争夺最终展示机会的初赛、复赛、决赛

召回、粗排、精排实际上是计算压力从大到小，模型复杂度从小到大的一个过程

#### 召回

> 召回(recall)就好像是初赛，比较简单，效率优先

一开始的索引库中可能有数万数十万的 item，这些 item 都是有资格被展示的，
如果直接上复杂模型对这么多 item 进行排序，性能是很差的

所以可以先设计方法简单性能高效的模型或规则策略，例如双塔模型、LR、FM以及各种规则策略。
用这些召回模块来挖掘出原则上任何用户有可能感兴趣的东西，
召回的输出一般在几千这样的量级

为什么这个环节叫做召回呢，因为这个环节不在乎你把多少错误的东西放进来，
但是非常在乎你没有把对的东西放进来(漏召回)

实践中，召回一般都会做多路召回策略:

* 第一种召回，是非个性化的
    - 比如对于新用户，要确保用最高质量的视频把他们留住，
      那么可以划一个"精品池"出来，作为一路召回
* 第二种召回，是 i2i，即 item-to-item，根据用户的历史 item，来找相似的 item
    - 比如说把用户过去点过赞的视频拿出来，去找画面上，BGM 上，
      或者用户行为结构上相似的视频
* 第三种召回，是 u2i，即纯粹从 user 和 item 的关系出发
    - 双塔就是一个典型的 u2i
    - 在用户请求过来的时候，计算出 user 的 embedding，
      然后去一个事先存好的 item embedding 的空间，寻找最相似的一批拿出来。
      由于要实时计算 user 特征，它的负担要大于前面两者，
      但这种召回个性化程度最高，一般会作为主路召回

#### 粗排

> 粗排(pre-rank)就好像是复赛，中等难度，平衡精效

召回的输出有数千，直接上精排的话可能还是比较慢，
可以使用一些中等复杂的模型(例如 MLP, DeepFM)对召回输出的几千个 item 进行初步的排序，
输出几百个到最终的精排环节。起到在召回和精排之间进行精度和效率的平衡

粗排环节不是必须的，如果索引库中的候选的 item 数量很少，甚至召回环节也可不要

#### 精排

> 精排(rank)就好像是决赛，疯狂难度，精度优先

精排是最纯粹的排序，也是最纯粹的机器学习模块。它的目标只有一个，
就是根据手头所有的信息输出最准的预测

精排的输入只有几百个，模型就可以非常复杂，
例如 DCN, 以及各种序列模型: DIEN、Transformer, MMOE 等。
是一个纯粹的追求模型精度的环节。
这个环节也是学术界各种相关的论文 paper 研究得最多的部分

### 打压保送重排

在模型之外，在推荐的整个过程中还穿插着许多策略(规则)环节来辅助。
这些策略有些是为了推荐的结果更好，有些则是为了某种长期规划或者营利诉求

![](https://tva1.sinaimg.cn/large/e6c9d24egy1h4p0ep9egqj20k00e6gm5.jpg)

推荐系统中常用到的一些策略包括以下三种:

1. 打压
    - 有政策风险或者与平台风格不符合的内容需要打压
2. 保送
    - 常见的是营收原因(金主爸爸掏钱了)需要保送
    - 此外，对于新内容，常常有一定的保送流量，以确保长尾效应，维持平台活力
3. 重排
    - 一是确保最终推荐内容的多样性
    - 二是防止重复推荐用户最近浏览过的内容

## 展示逻辑

第四步，现在已经确定把哪些内容推荐给用户了 

这就需要一个展示逻辑，许多时候最终呈现给用户的是图文的混排，
或者内容和广告的混排，这个时候需要设计适当的展示逻辑给到前端

经过物料索引、特征服务、排序模块、展示逻辑这样四步，
终于成功地把东西推给用户了，但是还不能收工，还有无穷无尽的监控和迭代

## 日志系统

第五步，为了监控的推荐是否有效，需要搭建日志系统，记录推送前后一切信息

这些信息包括推送前获取的特征、模型的排序结果以及推送后用户的行为反馈。
通过对比排序结果和用户反馈可以计算点击率以及浏览时长评估指标，
并且形成新的训练数据来让排序模块继续训练

## 分析系统

第六步，为了进一步迭代优化的推荐系统，需要做 AB 测试实验，并分析实验结果

这就需要一个分析系统，分析系统基于日志系统的数据。
AB 测试一般把用户随机进行划分为对照组(A 组,不添加改进点)和实验组(B 组,添加改进点)，
通过对比 AB 之间的差异，来展示所加的改进点是否有效。

推荐系统的迭代一般是这么个流程:

* 设计改进 idea -> 做线下实验 -> 上 AB 试试 -> 有效就推广到全量

# 推荐系统的局限性

尽管各个推荐系统平台都把自己的模型和算法吹得天花乱坠，
但实际上模型和算法对于推荐系统的成功的贡献是有限的，
并且具有它的局限性，主要体现在以下几点:

1. 优质内容是根本
   - 没有足够多用户喜爱的优质内容，推荐系统的模型算法再厉害也是无用武之地的。
     如果内容足够优质，非常简单的推荐算法就能够起到很好的效果
2. 存在用户信息茧房
   - 推荐系统存在着过分迎合用户偏好的倾向，
     让用户沉浸在一些短期的感觉刺激中浪费许多时间，
     这对用户的长期价值可能是负的
3. 模型自己学自己
   - 推荐系统的模型学习的数据是有偏的，
     都是曾经被模型选中的样本才有可能受到用户点赞喜欢获得正反馈成为正样本。
     虽然大部分推荐系统对新内容都有一些随机流量，
     但绝大部分样本都没有足够多的流量来进行评估。
     可能相同的内容换个 id 重新再发一遍就能获得多得多的流量，
     这里面存在着很大的随机性



