---
title: 时间序列基本规则法--周期因子法
author: 王哲峰
date: '2022-04-25'
slug: timeseries-factor
categories:
  - timeseries
tags:
  - ml
---




- 提取时间序列的周期性特征进行预测, 当序列存在周期性时, 可以用周期因子法作为 baseline.
- 对于像支付数据、客流量数据、交通数据等, 具有明显的周期性. 从预测的角度来说, 周期性是核心, 只要抓住了周期性, 任务就完成了一大半.

# 时间序列基本规则法快速入门

   - 计算周期因子 factor
   - 计算 base
   - 预测 - base \* factor

## 时间序列数据、任务

- 数据
  - 前三周的客流量数据, 即21天每天的客流量数据
- 任务
  - 预测第4周每天的客流量


|       | 周一 | 周二 | 周三 | 周四 | 周五 | 周六 | 周日 | 周均值 |
|-------|------|------|------|------|------|------|------|--------|
| 第1周 | 20   | 10   | 70   | 50   | 250  | 200  | 100  | 100    |
| 第1周 | 26   | 18   | 66   | 50   | 180  | 140  | 80   | 80     |
| 第3周 | 15   | 8    | 67   | 60   | 270  | 160  | 120  | 100    |

能够明显看到周一到周日的周期波动. 预测的核心任务就是尽可能准确地提取这种周期性. 

## 时间序列预测

- 第一步: 每周的客流量数据除以对应的周客流量均值, 得到一个比例值
- 第二步: 按列取中位数, 就可以得到一组鲁棒的周期因子
- 第三步: 取某一周的平均客流量数据作为一个基本客流量(base), 乘以周期因子, 得到下一周的预测客流量

|       | 周一  | 周二  | 周三  | 周四  | 周五 | 周六 | 周日 |
|-------|------|------|------|------|------|------|------|
| 第1周  | 0.2   | 0.1   | 0.7   | 0.5   | 2.5  | 2    | 1    |
| 第2周  | 0.325 | 0.225 | 0.825 | 0.625 | 2.25 | 1.75 | 1    |
| 第3周  | 0.15  | 0.08  | 0.67  | 0.6   | 2.7  | 1.6  | 1.2  |
| 中位数 | 0.2   | 0.1   | 0.7   | 0.6   | 2.5  | 1.75 | 1    |

取第3周的平均客流量 100 作为
base, 乘以周期因子(前三周的每天的中位数), 得到第4周的预测客流量: 

|                | 周一 | 周二 | 周三 | 周四 | 周五 | 周六 | 周日 |
|----------------|------|------|------|------|------|------|------|
| 中位数         | 0.2  | 0.1  | 0.7  | 0.6  | 2.5  | 1.75 | 1    |
| 预测(base-100) | 20   | 10   | 70   | 60   | 250  | 175  | 100  |

最终的数据: 


|               | 周一 | 周二 | 周三 | 周四 | 周五 | 周六 | 周日 |
|---------------|------|------|------|------|------|------|------|
| 第1周         | 20   | 10   | 70   | 50   | 250  | 200  | 100  |
| 第2周         | 26   | 18   | 66   | 50   | 180  | 140  | 80   |
| 第3周         | 15   | 8    | 67   | 60   | 270  | 160  | 120  |
| 第4周(预测值) | 20   | 10   | 70   | 60   | 250  | 175  | 100  |


## DataFrame 形式的计算过程

| timestamp  | metric | 周均值 | 比例值 | 周期因子 | base | 预测值 |
|------------|--------|-------|-------|---------|------|-------|
| 第1周 周一 | 20     | 100    | 0.2    |          |      |        |
| 第1周 周二 | 10     | 100    | 0.1    |          |      |        |
| 第1周 周三 | 70     | 100    | 0.7    |          |      |        |
| 第1周 周四 | 50     | 100    | 0.5    |          |      |        |
| 第1周 周五 | 250    | 100    | 2.5    |          |      |        |
| 第1周 周六 | 200    | 100    | 2.0    |          |      |        |
| 第1周 周日 | 100    | 100    | 1.0    |          |      |        |
| 第2周 周一 | 26     | 80     | 0.325  |          |      |        |
| 第2周 周二 | 18     | 80     | 0.225  |          |      |        |
| 第2周 周三 | 66     | 80     | 0.825  |          |      |        |
| 第2周 周四 | 50     | 80     | 0.625  |          |      |        |
| 第2周 周五 | 180    | 80     | 2.25   |          |      |        |
| 第2周 周六 | 140    | 80     | 1.75   |          |      |        |
| 第2周 周日 | 80     | 80     | 1      |          |      |        |
| 第3周 周一 | 15     | 100    | 0.15   |          |      |        |
| 第3周 周二 | 8      | 100    | 0.08   |          |      |        |
| 第3周 周三 | 67     | 100    | 0.67   |          |      |        |
| 第3周 周四 | 60     | 100    | 0.60   |          |      |        |
| 第3周 周五 | 270    | 100    | 2.7    |          |      |        |
| 第3周 周六 | 160    | 100    | 1.6    |          |      |        |
| 第3周 周日 | 120    | 100    | 1.2    |          |      |        |
| 第4周 周一 |        |        |        | 0.2      | 100  | 20     |
| 第4周 周二 |        |        |        | 0.1      | 100  | 10     |
| 第4周 周三 |        |        |        | 0.7      | 100  | 70     |
| 第4周 周四 |        |        |        | 0.6      | 100  | 60     |
| 第4周 周五 |        |        |        | 2.5      | 100  | 250    |
| 第4周 周六 |        |        |        | 1.75     | 100  | 175    |
| 第4周 周日 |        |        |        | 1        | 100  | 100    |


## 针对周期因子的优化

按列提取中位数是一种简单而有效的提取周期因子的方法. 中位数十分鲁棒, 不受极端值的影响. 
但中位数损失了很多信息. 实践中, 可以在此基础上进一步优化. 
比如可以提取一个均值和一个中位数, 然后将均值和中位数融合. 
融合的比例按照测试集的表现来确定. 也可以根据与预测周的时间距离来赋予不同的权重. 


## 针对 base 的优化

直接用最后一周的平均客流量作为 base 并不一定是最好的方法. 
也许最后三天或最后五天的均值能更好的反映最新的情况. 
但是, 我们不能直接对最后三天客流量取均值(最后三天是周末, 这样取的base就偏大了). 
需要去掉周期性因素后, 再取平均. 具体做法, 就是用客流量除以周期因子, 
然后取第3周最后三天的客流量的均值作为 base, 
即 base = (108 + 91.4 + 120) / 3 = 106.5. 
具体取多少天的, 也要通过测试集的表现来确定. 当然也可以按某些函数形式来给每天赋予不同的权重. 

|                    | 周一 | 周二 | 周三 | 周四 | 周五 | 周六 | 周日 |
|--------------------|------|------|------|------|------|------|------|
| 第3周              | 15   | 8    | 67   | 60   | 270  | 160  | 120  |
| 中位数             | 0.2  | 0.1  | 0.7  | 0.6  | 2.5  | 1.75 | 1    |
| 去周期以后的客流量 | 75   | 80   | 95.7 | 100  | 108  | 91.4 | 120  |

取 106.5 作为 base: 

|                  | 周一 | 周二  | 周三  | 周四 | 周五   | 周六    | 周日  |
|------------------|------|-------|-------|------|--------|---------|-------|
| 中位数           | 0.2  | 0.1   | 0.7   | 0.6  | 2.5    | 1.75    | 1     |
| 预测(base-106.5) | 21.3 | 10.65 | 74.55 | 63.9 | 266.25 | 186.375 | 106.5 |


最终的数据: 

|               | 周一 | 周二 | 周三 | 周四 | 周五 | 周六 | 周日 |
|---------------|------|------|------|------|------|------|------|
| 第1周         | 20   | 10   | 70   | 50   | 250  | 200  | 100  |
| 第2周         | 26   | 18   | 66   | 50   | 180  | 140  | 80   |
| 第3周         | 15   | 8    | 67   | 60   | 270  | 160  | 120  |
| 第4周(预测值) | 21   | 11   | 75   | 64   | 266  | 186  | 107  |


